虽然本次作业中要索引的网页是静态的，但考虑到”搜索引擎“这个名字，我们还是假装以后要定期更新网页信息，因此在模型中大量用到update_or_create()。这大大拖慢了速度，越到后期这个函数要查询的数据越多，运行也就越慢，目测结束时比开始时慢了十倍左右，如下(
本来用create()的话大概只需要1个半小时)：

![154539f60afffe37484adfed07f1d9c4_MD5.png](pictures%2F4.%20%E9%80%9F%E5%BA%A6%E4%BC%98%E5%8C%96%2F154539f60afffe37484adfed07f1d9c4_MD5.png)

查看了[[优化sqlite3速度]]之后，我第一步做的是在django里像他一样显示开启任务，批量执行SQL语句。

具体做法是在几个基础的函数上添加了`@transaction.atomic`标记。

改前前5000条用时：
```
当前进度：999/68417，总用时：123.65395903587341秒
当前进度：1999/68417，总用时：246.55316972732544秒
当前进度：2999/68417，总用时：371.1040680408478秒
当前进度：3999/68417，总用时：506.7788779735565秒
当前进度：4999/68417，总用时：641.8681755065918秒
```

改后前10000条用时：
```
当前进度：999/68417用时：34.04985427856445秒
当前进度：1999/68417用时：72.40004515647888秒
当前进度：2999/68417用时：118.16527771949768秒
当前进度：3999/68417用时：170.25840783119202秒
当前进度：4999/68417用时：221.5308060646057秒
当前进度：5999/68417用时：277.9871973991394秒
当前进度：6999/68417用时：339.6625759601593秒
当前进度：7999/68417用时：404.6741075515747秒
当前进度：8999/68417用时：472.87201833724976秒
当前进度：9999/68417用时：543.7172710895538秒
```

速度提升比较明显。

后续结合索引，更新/添加数据的速度更快。下面是优化后向一个空数据库添加所有数据的用时，速度相较于没有优化时提高了7倍。

![76d98faade2f6beb28b5a55cdddee671_MD5.png](pictures%2F4.%20%E9%80%9F%E5%BA%A6%E4%BC%98%E5%8C%96%2F76d98faade2f6beb28b5a55cdddee671_MD5.png)

TODO: 其他优化策略：

> 1. 使用多进程或多线程。由于数据是本地的,多进程/线程可以有效地提高读取速度。你可以启动多个进程/线程,每个进程/线程读取和解析部分数据,最后合并结果。
> 2.  采用更高效的解析库。bs4 是比较简单的解析库,解析效率较低。你可以考虑使用 lxml 或 html5lib 等解析库,它们的解析速度会快很多。
> 3. 缓存解析结果。读取和解析网页是比较耗时的操作,你可以考虑将解析结果缓存,避免重复解析同一个网页。
> 4. 减少不必要的字符串操作。在解析和提取信息的过程中,避免过多的字符串拼接、分割等操作,这会降低效率。
> 5. 提取关键信息。对网页进行聚焦式解析,避免解析和提取无用信息。只提取你真正需要的内容。
> 6. 使用生成器函数。在存入模型的过程中,可以考虑使用生成器函数,这可以避免一次性将所有数据加载到内存中,从而提高效率。一个示例:
> 
```python
from multiprocessing import Pool
from lxml import html

def parse(html_file):
    # 使用lxml解析,效率更高
    with open(html_file) as f:
        doc = html.fromstring(f.read())
    # 只提取关键信息
    infos = doc.xpath(...)  
    
    for info in infos:
        # 使用生成器函数
        yield Model(info) 
if __name__ == '__main__':
    pool = Pool() # 启动多进程池
    files = [f for f in os.listdir('data')]  # 待解析的网页
    pool.map(partial(parse), files)  # 多进程解析网页
```